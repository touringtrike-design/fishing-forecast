<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#2563eb" />
    <meta name="description" content="üé£ Fishing Forecast - AI-powered fishing prediction app with weather data, catch logging, and personalized forecasts." />
    
    <!-- PWA Manifest -->
    <link data-trunk rel="copy-file" href="assets/manifest.json" data-trunk-to="manifest.json" />
    <link data-trunk rel="copy-file" href="assets/sw.js" data-trunk-to="sw.js" />
    <link data-trunk rel="copy-dir" href="assets/images" data-trunk-to="images" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/images/fishing-icon.svg" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Fishing Forecast" />
    
    <title>Fishing Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    
    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('‚úÖ Service Worker registered:', registration.scope);
            })
            .catch(error => {
              console.log('‚ùå Service Worker registration failed:', error);
            });
        });
      }
    </script>
  </head>
  <body>
    <div id="main"></div>
    
    <style>
      /* Ensure Leaflet container has proper dimensions */
      #leaflet-map {
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1;
      }
      
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      
      #main {
        width: 100%;
        height: 100%;
      }
    </style>
    
    <script>
      // Global variables for Leaflet map
      let fishingMap = null;
      let currentMarker = null;
      let userMarker = null;
      let windArrow = null;
      let clickCallback = null;
      let userLocation = null;
      let currentWindDirection = 0;
      
      // Offline status indicator
      window.addEventListener('online', () => {
        console.log('üü¢ Back online');
        const status = document.getElementById('connection-status');
        if (status) status.remove();
      });
      
      window.addEventListener('offline', () => {
        console.log('üî¥ Went offline');
        const status = document.createElement('div');
        status.id = 'connection-status';
        status.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-9999';
        status.innerHTML = '‚ö†Ô∏è –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
        document.body.appendChild(status);
      });
      
      // Get user location
      window.getUserLocation = function(callback) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              userLocation = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
              };
              callback(userLocation.lat, userLocation.lon);
            },
            function(error) {
              console.error('Geolocation error:', error);
              // Use default location if geolocation fails
              userLocation = { lat: 50.45, lon: 30.52 }; // Kyiv default
              callback(userLocation.lat, userLocation.lon);
            }
          );
        } else {
          console.log('Geolocation not supported');
          userLocation = { lat: 50.45, lon: 30.52 };
          callback(userLocation.lat, userLocation.lon);
        }
      };
      
      // Request geolocation on page load and update marker
      function requestGeolocationWithRetry() {
        if (navigator.geolocation) {
          console.log('üåç Requesting geolocation from browser...');
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              const accuracy = position.coords.accuracy;
              console.log('‚úÖ Geolocation success:', lat.toFixed(4), lon.toFixed(4), 'accuracy:', Math.round(accuracy), 'm');
              userLocation = { lat: lat, lon: lon };
              
              // Store in localStorage for offline use
              try {
                localStorage.setItem('user_location', JSON.stringify(userLocation));
                localStorage.setItem('last_location_time', Date.now().toString());
              } catch (e) {
                console.log('Could not save to localStorage:', e);
              }
              
              console.log('üìç Attempting to update marker with real geolocation...');
              window.updateUserMarker(lat, lon, 0.0, 0.0);
            },
            function(error) {
              console.warn('‚ùå Geolocation error:', error.code, error.message);
              // Try to restore from localStorage
              try {
                const stored = localStorage.getItem('user_location');
                if (stored) {
                  const loc = JSON.parse(stored);
                  console.log('Using stored location:', loc.lat, loc.lon);
                  userLocation = loc;
                  window.updateUserMarker(loc.lat, loc.lon, 0.0, 0.0);
                  return;
                }
              } catch (e) {
                console.log('Could not restore from localStorage:', e);
              }
              // Fall back to Kyiv center
              console.log('Using Kyiv as fallback');
              userLocation = { lat: 50.45, lon: 30.52 };
              window.updateUserMarker(50.45, 30.52, 0.0, 0.0);
            },
            {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0
            }
          );
        } else {
          console.log('Geolocation not supported by this browser');
          userLocation = { lat: 50.45, lon: 30.52 };
        }
      }
      
      // Request geolocation immediately on page load
      document.addEventListener('DOMContentLoaded', requestGeolocationWithRetry);
      
      // Also try after delay to ensure browser permissions are ready
      setTimeout(requestGeolocationWithRetry, 500);
      setTimeout(requestGeolocationWithRetry, 2000);
      
      // Watch for the leaflet-map container and ensure it's initialized
      function checkAndInitializeMap() {
        const container = document.getElementById('leaflet-map');
        if (container && !fishingMap) {
          console.log('üìç Leaflet container found, container size:', container.offsetWidth, 'x', container.offsetHeight);
          if (container.offsetWidth > 0 && container.offsetHeight > 0) {
            console.log('üó∫Ô∏è Container has size, initializing map...');
            setTimeout(() => {
              if (!fishingMap) {
                console.log('‚ö†Ô∏è Map still not initialized, checking...');
              } else {
                console.log('‚úÖ Map is ready, triggering geolocation update...');
                requestGeolocationWithRetry();
              }
            }, 500);
          } else {
            console.log('‚ö†Ô∏è Container not ready yet, size:', container.offsetWidth, 'x', container.offsetHeight);
          }
        }
      }
      
      // Check for container every 100ms for first 2 seconds
      let checkCount = 0;
      const mapCheckInterval = setInterval(() => {
        checkAndInitializeMap();
        checkCount++;
        if (checkCount > 20) {
          clearInterval(mapCheckInterval);
        }
      }, 100);
      
      // Update user marker on map
      window.updateUserMarker = function(lat, lon, heading, windDirection) {
        console.log('üìå updateUserMarker called with:', lat.toFixed(4), lon.toFixed(4), 'fishingMap ready:', !!fishingMap);
        
        if (!fishingMap) {
          console.log('‚ö†Ô∏è Map not ready for updateUserMarker, but continuing...');
          const container = document.getElementById('leaflet-map');
          if (container && !container.firstChild) {
            console.log('üó∫Ô∏è Initializing map from updateUserMarker');
            window.initLeafletMap('leaflet-map', lat, lon, 10);
          } else if (!container) {
            console.error('‚ùå Container not found!');
            return;
          }
          setTimeout(() => window.updateUserMarker(lat, lon, heading, windDirection), 500);
          return;
        }
        
        console.log('‚úÖ Map is ready, adding user marker at', lat.toFixed(4), lon.toFixed(4));
        
        currentWindDirection = windDirection || 0;
        
        if (userMarker) {
          fishingMap.removeLayer(userMarker);
        }
        if (windArrow) {
          fishingMap.removeLayer(windArrow);
        }
        
        const userIcon = L.divIcon({
          className: 'user-location-marker',
          html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 110" width="45" height="55" style="display: block; animation: marker-appear 0.6s ease-out;">
            <defs>
              <filter id="userShadow">
                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
              </filter>
            </defs>
            <g filter="url(#userShadow)">
              <!-- –ì–æ–ª–æ–≤–∞ -->
              <circle cx="30" cy="22" r="11" fill="#F5B8A0"/>
              <!-- –¢—ñ–ª–æ (—Ñ—É—Ç–±–æ–ª–∫–∞ —á–µ—Ä–≤–æ–Ω–∞) -->
              <path d="M 20 32 Q 20 30, 22 28 L 38 28 Q 40 30, 40 32 L 40 55 Q 40 58, 37 58 L 23 58 Q 20 58, 20 55 Z" fill="#E94444"/>
              <!-- –õ—ñ–≤–∞ —Ä—É–∫–∞ -->
              <path d="M 22 32 Q 18 35, 17 42 Q 16 45, 18 47 L 25 50 Q 26 49, 25 47 L 22 38 Z" fill="#F5B8A0"/>
              <!-- –ü—Ä–∞–≤–∞ —Ä—É–∫–∞ -->
              <path d="M 38 32 Q 42 35, 43 42 Q 44 45, 42 47 L 35 50 Q 34 49, 35 47 L 38 38 Z" fill="#F5B8A0"/>
              <!-- –®—Ç–∞–Ω–∏ -->
              <rect x="20" y="56" width="20" height="38" rx="3" fill="#5C6B87"/>
              <!-- –õ—ñ–≤–∞ –Ω–æ–≥–∞ -->
              <path d="M 22 94 L 22 102 Q 22 104, 24 104 L 28 104 Q 30 104, 30 102 L 30 94 Z" fill="#5C6B87"/>
              <!-- –ü—Ä–∞–≤–∞ –Ω–æ–≥–∞ -->
              <path d="M 30 94 L 30 102 Q 30 104, 32 104 L 36 104 Q 38 104, 38 102 L 38 94 Z" fill="#5C6B87"/>
            </g>
          </svg>`,
          iconSize: [45, 55],
          iconAnchor: [30, 104],
          popupAnchor: [0, -104]
        });
        
        userMarker = L.marker([lat, lon], { icon: userIcon }).addTo(fishingMap);
        userMarker.bindPopup(`<div style="text-align: center; padding: 5px;"><strong style="color: #2563eb;">üìç –í–∞—à–µ –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è</strong><br/><span style="font-family: monospace; font-size: 12px;">${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞</span></div>`);
        
        if (windDirection !== undefined && windDirection !== null) {
          const windIcon = L.divIcon({
            className: 'wind-arrow-marker',
            html: `<svg width="140" height="140" viewBox="0 0 140 140" style="display: block;">
              <defs>
                <style>
                  @keyframes windFlow {
                    0% { opacity: 0; transform: translate(0, 0); }
                    10% { opacity: 0.6; }
                    90% { opacity: 0.6; }
                    100% { opacity: 0; transform: translate(30px, 30px); }
                  }
                  .wind-line { animation: windFlow 2.5s ease-in-out infinite; }
                </style>
              </defs>
              
              <!-- –ü–∞—Ä–∞–ª–µ–ª—å–Ω—ñ –ª—ñ–Ω—ñ—ó –≤—ñ—Ç—Ä—É (—è–∫ –Ω–∞ meteoblue) -->
              <g transform="translate(70, 70) rotate(${windDirection})">
                <!-- –†—è–¥ 1 (—Ü–µ–Ω—Ç—Ä) -->
                <line class="wind-line" style="animation-delay: 0s;" 
                      x1="-40" y1="0" x2="-10" y2="0" 
                      stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
                
                <line class="wind-line" style="animation-delay: 0.3s;" 
                      x1="-30" y1="0" x2="5" y2="0" 
                      stroke="white" stroke-width="2.5" stroke-linecap="round" opacity="0.9"/>
                
                <line class="wind-line" style="animation-delay: 0.6s;" 
                      x1="-20" y1="0" x2="15" y2="0" 
                      stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
                
                <!-- –†—è–¥ 2 (–≤–∏—â–µ) -->
                <line class="wind-line" style="animation-delay: 0.1s;" 
                      x1="-45" y1="-8" x2="-15" y2="-8" 
                      stroke="white" stroke-width="1.8" stroke-linecap="round" opacity="0.7"/>
                
                <line class="wind-line" style="animation-delay: 0.4s;" 
                      x1="-35" y1="-8" x2="0" y2="-8" 
                      stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
                
                <line class="wind-line" style="animation-delay: 0.7s;" 
                      x1="-25" y1="-8" x2="10" y2="-8" 
                      stroke="white" stroke-width="1.8" stroke-linecap="round" opacity="0.7"/>
                
                <!-- –†—è–¥ 3 (—â–µ –≤–∏—â–µ) -->
                <line class="wind-line" style="animation-delay: 0.2s;" 
                      x1="-50" y1="-16" x2="-20" y2="-16" 
                      stroke="white" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
                
                <line class="wind-line" style="animation-delay: 0.5s;" 
                      x1="-40" y1="-16" x2="-5" y2="-16" 
                      stroke="white" stroke-width="1.8" stroke-linecap="round" opacity="0.7"/>
                
                <line class="wind-line" style="animation-delay: 0.8s;" 
                      x1="-30" y1="-16" x2="5" y2="-16" 
                      stroke="white" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
                
                <!-- –†—è–¥ 4 (–Ω–∏–∂—á–µ —Ü–µ–Ω—Ç—Ä—É) -->
                <line class="wind-line" style="animation-delay: 0.15s;" 
                      x1="-45" y1="8" x2="-15" y2="8" 
                      stroke="white" stroke-width="1.8" stroke-linecap="round" opacity="0.7"/>
                
                <line class="wind-line" style="animation-delay: 0.45s;" 
                      x1="-35" y1="8" x2="0" y2="8" 
                      stroke="white" stroke-width="2" stroke-linecap="round" opacity="0.8"/>
                
                <line class="wind-line" style="animation-delay: 0.75s;" 
                      x1="-25" y1="8" x2="10" y2="8" 
                      stroke="white" stroke-width="1.8" stroke-linecap="round" opacity="0.7"/>
                
                <!-- –†—è–¥ 5 (—â–µ –Ω–∏–∂—á–µ) -->
                <line class="wind-line" style="animation-delay: 0.25s;" 
                      x1="-50" y1="16" x2="-20" y2="16" 
                      stroke="white" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
                
                <line class="wind-line" style="animation-delay: 0.55s;" 
                      x1="-40" y1="16" x2="-5" y2="16" 
                      stroke="white" stroke-width="1.8" stroke-linecap="round" opacity="0.7"/>
                
                <line class="wind-line" style="animation-delay: 0.85s;" 
                      x1="-30" y1="16" x2="5" y2="16" 
                      stroke="white" stroke-width="1.5" stroke-linecap="round" opacity="0.6"/>
                
                <!-- –î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤–µ—Ä—Ö–Ω—ñ –ª—ñ–Ω—ñ—ó -->
                <line class="wind-line" style="animation-delay: 0.35s;" 
                      x1="-48" y1="-24" x2="-18" y2="-24" 
                      stroke="white" stroke-width="1.3" stroke-linecap="round" opacity="0.5"/>
                
                <line class="wind-line" style="animation-delay: 0.65s;" 
                      x1="-38" y1="-24" x2="-8" y2="-24" 
                      stroke="white" stroke-width="1.3" stroke-linecap="round" opacity="0.5"/>
                
                <!-- –î–æ–¥–∞—Ç–∫–æ–≤—ñ –Ω–∏–∂–Ω—ñ –ª—ñ–Ω—ñ—ó -->
                <line class="wind-line" style="animation-delay: 0.4s;" 
                      x1="-48" y1="24" x2="-18" y2="24" 
                      stroke="white" stroke-width="1.3" stroke-linecap="round" opacity="0.5"/>
                
                <line class="wind-line" style="animation-delay: 0.7s;" 
                      x1="-38" y1="24" x2="-8" y2="24" 
                      stroke="white" stroke-width="1.3" stroke-linecap="round" opacity="0.5"/>
                
                <!-- –ù–∞–π–¥–∞–ª—å—à—ñ –ª—ñ–Ω—ñ—ó -->
                <line class="wind-line" style="animation-delay: 0.5s;" 
                      x1="-52" y1="-32" x2="-27" y2="-32" 
                      stroke="white" stroke-width="1.2" stroke-linecap="round" opacity="0.4"/>
                
                <line class="wind-line" style="animation-delay: 0.55s;" 
                      x1="-52" y1="32" x2="-27" y2="32" 
                      stroke="white" stroke-width="1.2" stroke-linecap="round" opacity="0.4"/>
              </g>
            </svg>`,
            iconSize: [140, 140],
            iconAnchor: [70, 70]
          });
          
          const offsetLat = lat + 0.0;
          const offsetLon = lon + 0.0;
          windArrow = L.marker([offsetLat, offsetLon], { icon: windIcon }).addTo(fishingMap);
          windArrow.bindPopup(`<strong>üí® –í—ñ—Ç–µ—Ä: ${(windDirection.toFixed(0))}¬∞</strong>`);
        }
        
        fishingMap.panTo([lat, lon]);
      };
      
      // Initialize Leaflet map
      window.initLeafletMap = function(containerId, lat, lon, zoom) {
        console.log('üó∫Ô∏è Initializing Leaflet map in container:', containerId);
        
        if (fishingMap) {
          console.log('Removing existing map');
          fishingMap.remove();
        }
        
        const container = document.getElementById(containerId);
        if (!container) {
          console.error('‚ùå Container element not found:', containerId);
          return;
        }
        
        console.log('Container found, size:', container.offsetWidth, 'x', container.offsetHeight);
        
        fishingMap = L.map(containerId, {
          attributionControl: true,
          preferCanvas: true
        }).setView([lat, lon], zoom);
        
        console.log('Map instance created:', !!fishingMap);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 18,
          minZoom: 3
        }).addTo(fishingMap);
        
        console.log('‚úÖ Tile layer added');
        
        setTimeout(() => {
          if (fishingMap) {
            fishingMap.invalidateSize();
            console.log('‚úÖ Map size invalidated');
          }
        }, 100);
        
        
        fishingMap.on('click', function(e) {
          const lat = e.latlng.lat;
          const lon = e.latlng.lng;
          
          if (clickCallback) {
            clickCallback(lat, lon);
          }
        });
      };
      
      // SVG icon data URI for fishing location marker
      const fishingLocationMarkerSVG = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0MDUgNDU0IiB3aWR0aD0iNDA1IiBoZWlnaHQ9IjQ1NCI+PGVsbGlwc2UgY3g9IjIwMiIgY3k9IjM3MCIgcng9IjE3NSIgcnk9IjQyIiBmaWxsPSIjQjhENEU4IiBvcGFjaXR5PSIwLjYiLz48cGF0aCBkPSJNIDIwMiA0MCBDIDEyMCA0MCwgNTUgMTA1LCA1NSAxODcgQyA1NSAyNDUsIDkwIDI5NSwgMjAyIDQwMCBDIDMxNCAyOTUsIDM0OSAyNDUsIDM0OSAxODcgQyAzNDkgMTA1LCAyODQgNDAsIDIwMiA0MCBaIiBmaWxsPSIjMUIzQTUyIiBzdHJva2U9Im5vbmUiLz48cGF0aCBkPSJNIDIwMiA1MCBDIDEyOCA1MCwgNjggMTEwLCA2OCAxODQgQyA2OCAyMzgsIDEwMCAyODQsIDIwMiAzODUgQyAzMDQgMjg0LCAzMzYgMjM4LCAzMzYgMTg0IEMgMzM2IDExMCwgMjc2IDUwLCAyMDIgNTAgWiIgZmlsbD0iIzVCOUZEOCIgc3Ryb2tlPSJub25lIi8+PGNpcmNsZSBjeD0iMjAyIiBjeT0iMTY1IiByPSI4NSIgZmlsbD0iIzhEQzRGNSIvPjxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIwMiwgMTY1KSI+PHBhdGggZD0iTSAtNSAtNTUgQyAtNSAtNTgsIC0zIC02MCwgMCAtNjAgQyAzIC02MCwgNSAtNTgsIDUgLTU1IEwgNSAtNDUgQyA1IC00MywgMyAtNDEsIDAgLTQxIEMgLTMgLTQxLCAtNSAtNDMsIC01IC00NSBaIiBmaWxsPSIjMUIzQTUyIi8+PGNpcmNsZSBjeD0iMCIgY3k9Ii00OCIgcj0iOCIgZmlsbD0iIzVCN0E5MiIvPjxyZWN0IHg9Ii02IiB5PSItNDAiIHdpZHRoPSIxMiIgaGVpZ2h0PSI1NSIgcng9IjYiIGZpbGw9IiMxQjNBNTIiLz48cGF0aCBkPSJNIC02IDEwIEwgLTYgMzAgQyAtNiA0NSwgNiA1NSwgMjAgNTUgQyAzNCA1NSwgNDYgNDUsIDQ2IDMwIEMgNDYgMTgsIDM4IDgsIDI2IDggTCAyNiAxOCBDIDMyIDE4LCAzNiAyMiwgMzYgMzAgQyAzNiAzOCwgMzAgNDUsIDIwIDQ1IEMgMTAgNDUsIDQgMzgsIDQgMzAgTCA0IDEwIFoiIGZpbGw9IiNGRkZGRkYiLz48cGF0aCBkPSJNIDI2IDggTCAzMiAyIEwgMjYgMCBaIiBmaWxsPSIjMUIzQTUyIi8+PC9nPjwvc3ZnPg==';
      
      // Update or create marker
      window.updateLeafletMarker = function(lat, lon) {
        if (!fishingMap) return;
        
        if (currentMarker) {
          fishingMap.removeLayer(currentMarker);
        }
        
        const fishIcon = L.divIcon({
          className: 'fishing-float-marker',
          html: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 110" width="45" height="55" style="display: block; animation: marker-appear 0.6s ease-out;">
            <defs>
              <filter id="fisherShadow">
                <feDropShadow dx="0" dy="2" stdDeviation="2" flood-opacity="0.3"/>
              </filter>
            </defs>
            <g filter="url(#fisherShadow)">
              <!-- –ì–æ–ª–æ–≤–∞ -->
              <circle cx="30" cy="22" r="11" fill="#F5B8A0"/>
              <!-- –¢—ñ–ª–æ (—Ñ—É—Ç–±–æ–ª–∫–∞) -->
              <path d="M 20 32 Q 20 30, 22 28 L 38 28 Q 40 30, 40 32 L 40 55 Q 40 58, 37 58 L 23 58 Q 20 58, 20 55 Z" fill="#5BA3E0"/>
              <!-- –õ—ñ–≤–∞ —Ä—É–∫–∞ -->
              <path d="M 22 32 Q 18 35, 17 42 Q 16 45, 18 47 L 25 50 Q 26 49, 25 47 L 22 38 Z" fill="#F5B8A0"/>
              <!-- –ü—Ä–∞–≤–∞ —Ä—É–∫–∞ –∑ –≤—É–¥–∫–æ—é -->
              <path d="M 38 32 Q 42 35, 45 42 L 48 45 Q 49 46, 48 47 L 41 50 Q 40 49, 41 47 L 38 38 Z" fill="#F5B8A0"/>
              <!-- –®—Ç–∞–Ω–∏ -->
              <rect x="20" y="56" width="20" height="38" rx="3" fill="#5C6B87"/>
              <!-- –õ—ñ–≤–∞ –Ω–æ–≥–∞ -->
              <path d="M 22 94 L 22 102 Q 22 104, 24 104 L 28 104 Q 30 104, 30 102 L 30 94 Z" fill="#5C6B87"/>
              <!-- –ü—Ä–∞–≤–∞ –Ω–æ–≥–∞ -->
              <path d="M 30 94 L 30 102 Q 30 104, 32 104 L 36 104 Q 38 104, 38 102 L 38 94 Z" fill="#5C6B87"/>
              <!-- –í—É–¥–∫–∞ (—Ç—Ä–æ—Ö–∏ –¥–æ–≤—à–∞) -->
              <line x1="48" y1="45" x2="75" y2="18" stroke="#7FB5D9" stroke-width="3" stroke-linecap="round"/>
              <line x1="48" y1="45" x2="80" y2="8" stroke="#7FB5D9" stroke-width="2.5" stroke-linecap="round"/>
              <!-- –õ–µ—Å–∫–∞ -->
              <line x1="80" y1="8" x2="85" y2="35" stroke="#999" stroke-width="0.8" opacity="0.7"/>
            </g>
          </svg>`,
          iconSize: [45, 55],
          iconAnchor: [30, 104],
          popupAnchor: [0, -104]
        });
        
        currentMarker = L.marker([lat, lon], { icon: fishIcon }).addTo(fishingMap);
        
        currentMarker.bindPopup(`
          <div style="text-align: center;">
            <strong>üé£ –ú—ñ—Å—Ü–µ –ª–æ–≤—É</strong><br/>
            <span style="font-family: monospace;">${lat.toFixed(2)}¬∞, ${lon.toFixed(2)}¬∞</span>
          </div>
        `).openPopup();
        
        fishingMap.panTo([lat, lon]);
      };
      
      // Set click handler callback
      window.setLeafletClickHandler = function(callback) {
        clickCallback = callback;
      };
    </script>
  </body>
</html>
