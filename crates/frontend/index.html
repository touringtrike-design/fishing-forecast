<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#2563eb" />
    <meta name="description" content="üé£ Fishing Forecast - AI-powered fishing prediction app with weather data, catch logging, and personalized forecasts." />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Fishing Forecast" />
    
    <title>Fishing Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    
    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('‚úÖ Service Worker registered:', registration.scope);
            })
            .catch(error => {
              console.log('‚ùå Service Worker registration failed:', error);
            });
        });
      }
    </script>
  </head>
  <body>
    <div id="main"></div>
    
    <style>
      /* Ensure Leaflet container has proper dimensions */
      #leaflet-map {
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1;
      }
      
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      
      #main {
        width: 100%;
        height: 100%;
      }
    </style>
    
    <script>
      // Global variables for Leaflet map
      let fishingMap = null;
      let currentMarker = null;
      let userMarker = null;
      let windArrow = null;
      let clickCallback = null;
      let userLocation = null;
      let currentWindDirection = 0;
      
      // Offline status indicator
      window.addEventListener('online', () => {
        console.log('üü¢ Back online');
        const status = document.getElementById('connection-status');
        if (status) status.remove();
      });
      
      window.addEventListener('offline', () => {
        console.log('üî¥ Went offline');
        const status = document.createElement('div');
        status.id = 'connection-status';
        status.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-9999';
        status.innerHTML = '‚ö†Ô∏è –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
        document.body.appendChild(status);
      });
      
      // Get user location
      window.getUserLocation = function(callback) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              userLocation = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
              };
              callback(userLocation.lat, userLocation.lon);
            },
            function(error) {
              console.error('Geolocation error:', error);
              // Use default location if geolocation fails
              userLocation = { lat: 50.45, lon: 30.52 }; // Kyiv default
              callback(userLocation.lat, userLocation.lon);
            }
          );
        } else {
          console.log('Geolocation not supported');
          userLocation = { lat: 50.45, lon: 30.52 };
          callback(userLocation.lat, userLocation.lon);
        }
      };
      
      // Request geolocation on page load and update marker
      function requestGeolocationWithRetry() {
        if (navigator.geolocation) {
          console.log('üåç Requesting geolocation from browser...');
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              const accuracy = position.coords.accuracy;
              console.log('‚úÖ Geolocation success:', lat.toFixed(4), lon.toFixed(4), 'accuracy:', Math.round(accuracy), 'm');
              userLocation = { lat: lat, lon: lon };
              
              // Store in localStorage for offline use
              try {
                localStorage.setItem('user_location', JSON.stringify(userLocation));
                localStorage.setItem('last_location_time', Date.now().toString());
              } catch (e) {
                console.log('Could not save to localStorage:', e);
              }
              
              console.log('üìç Attempting to update marker with real geolocation...');
              window.updateUserMarker(lat, lon, 0.0, 0.0);
            },
            function(error) {
              console.warn('‚ùå Geolocation error:', error.code, error.message);
              // Try to restore from localStorage
              try {
                const stored = localStorage.getItem('user_location');
                if (stored) {
                  const loc = JSON.parse(stored);
                  console.log('Using stored location:', loc.lat, loc.lon);
                  userLocation = loc;
                  window.updateUserMarker(loc.lat, loc.lon, 0.0, 0.0);
                  return;
                }
              } catch (e) {
                console.log('Could not restore from localStorage:', e);
              }
              // Fall back to Kyiv center
              console.log('Using Kyiv as fallback');
              userLocation = { lat: 50.45, lon: 30.52 };
              window.updateUserMarker(50.45, 30.52, 0.0, 0.0);
            },
            {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0
            }
          );
        } else {
          console.log('Geolocation not supported by this browser');
          userLocation = { lat: 50.45, lon: 30.52 };
        }
      }
      
      // Request geolocation immediately on page load
      document.addEventListener('DOMContentLoaded', requestGeolocationWithRetry);
      
      // Also try after delay to ensure browser permissions are ready
      setTimeout(requestGeolocationWithRetry, 500);
      setTimeout(requestGeolocationWithRetry, 2000);
      
      // Watch for the leaflet-map container and ensure it's initialized
      function checkAndInitializeMap() {
        const container = document.getElementById('leaflet-map');
        if (container && !fishingMap) {
          console.log('üìç Leaflet container found, container size:', container.offsetWidth, 'x', container.offsetHeight);
          if (container.offsetWidth > 0 && container.offsetHeight > 0) {
            console.log('üó∫Ô∏è Container has size, initializing map...');
            setTimeout(() => {
              if (!fishingMap) {
                console.log('‚ö†Ô∏è Map still not initialized, checking...');
              } else {
                console.log('‚úÖ Map is ready, triggering geolocation update...');
                requestGeolocationWithRetry();
              }
            }, 500);
          } else {
            console.log('‚ö†Ô∏è Container not ready yet, size:', container.offsetWidth, 'x', container.offsetHeight);
          }
        }
      }
      
      // Check for container every 100ms for first 2 seconds
      let checkCount = 0;
      const mapCheckInterval = setInterval(() => {
        checkAndInitializeMap();
        checkCount++;
        if (checkCount > 20) {
          clearInterval(mapCheckInterval);
        }
      }, 100);
      
      // Add CSS animations for user marker and wind arrows
      const style = document.createElement('style');
      style.textContent = `
        @keyframes pulse-ring {
          0% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7), 0 0 0 10px rgba(59, 130, 246, 0.5);
            }
            50% {
              box-shadow: 0 0 0 10px rgba(59, 130, 246, 0.5), 0 0 0 20px rgba(59, 130, 246, 0.2);
            }
            100% {
              box-shadow: 0 0 0 20px rgba(59, 130, 246, 0.2), 0 0 0 30px rgba(59, 130, 246, 0);
            }
          }
          
          @keyframes pulse-dot {
            0%, 100% {
              transform: scale(1);
              opacity: 1;
            }
            50% {
              transform: scale(1.1);
              opacity: 0.9;
            }
          }
          
          @keyframes rotate-wind {
            0% {
              transform: rotate(0deg);
            }
            100% {
              transform: rotate(360deg);
            }
          }
          
          @keyframes wind-pulse {
            0%, 100% {
              opacity: 0.7;
              transform: scale(1);
            }
            50% {
              opacity: 1;
              transform: scale(1.1);
            }
          }
          
          .user-location-pulse {
            animation: pulse-ring 2s infinite;
          }
          
          .user-location-dot {
            animation: pulse-dot 2s infinite;
          }
          
          .wind-arrow-halo {
            animation: rotate-wind 8s linear infinite;
          }
          
          .wind-arrow-item {
            animation: wind-pulse 2s ease-in-out infinite;
          }
        `;
      document.head.appendChild(style);
      
      // Update user marker on map
      window.updateUserMarker = function(lat, lon, heading, windDirection) {
        console.log('üìå updateUserMarker called with:', lat.toFixed(4), lon.toFixed(4), 'fishingMap ready:', !!fishingMap);
        
        if (!fishingMap) {
          console.log('‚ö†Ô∏è Map not ready for updateUserMarker, but continuing...');
          const container = document.getElementById('leaflet-map');
          if (container && !container.firstChild) {
            console.log('üó∫Ô∏è Initializing map from updateUserMarker');
            window.initLeafletMap('leaflet-map', lat, lon, 10);
          } else if (!container) {
            console.error('‚ùå Container not found!');
            return;
          }
          setTimeout(() => window.updateUserMarker(lat, lon, heading, windDirection), 500);
          return;
        }
        
        console.log('‚úÖ Map is ready, adding user marker at', lat.toFixed(4), lon.toFixed(4));
        
        currentWindDirection = windDirection || 0;
        
        if (userMarker) {
          fishingMap.removeLayer(userMarker);
        }
        if (windArrow) {
          fishingMap.removeLayer(windArrow);
        }
        
        const userIcon = L.divIcon({
          className: 'user-location-marker user-location-dot',
          html: `<svg width="56" height="66" viewBox="0 0 56 66">
            <circle cx="28" cy="8" r="8" fill="#ff5252" stroke="#ff5252" stroke-width="1.5"/>
            <ellipse cx="23" cy="5" rx="2" ry="2.5" fill="#ff8a80" opacity="0.6"/>
            <rect x="26" y="16" width="4" height="40" rx="2" fill="#3d4d57"/>
            <line x1="8" y1="56" x2="48" y2="56" stroke="#3d4d57" stroke-width="6" stroke-linecap="round"/>
            <line x1="28" y1="40" x2="28" y2="66" stroke="#3d4d57" stroke-width="6" stroke-linecap="round"/>
          </svg>`,
          iconSize: [56, 66],
          iconAnchor: [28, 56],
          popupAnchor: [0, -50]
        });
        
        userMarker = L.marker([lat, lon], { icon: userIcon }).addTo(fishingMap);
        userMarker.bindPopup(`<div style="text-align: center; padding: 5px;"><strong style="color: #2563eb;">üìç –í–∞—à–µ –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è</strong><br/><span style="font-family: monospace; font-size: 12px;">${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞</span></div>`);
        
        if (windDirection !== undefined && windDirection !== null) {
          // Create animated halo of wind arrows
          const arrowCount = 8;
          const radius = 35;
          const haloSize = 100; // Total size of the halo container
          const delayIncrement = 0.25; // Animation delay between arrows
          let arrowsHtml = `<div class="wind-arrow-halo" style="position: relative; width: ${haloSize}px; height: ${haloSize}px;">`;
          
          for (let i = 0; i < arrowCount; i++) {
            const angle = ((i * 360 / arrowCount) + windDirection) % 360;
            const radian = (angle * Math.PI) / 180;
            const x = haloSize / 2 + radius * Math.cos(radian);
            const y = haloSize / 2 + radius * Math.sin(radian);
            const delay = i * delayIncrement;
            
            arrowsHtml += `
              <div class="wind-arrow-item" style="
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                transform: translate(-50%, -50%) rotate(${angle + 90}deg);
                font-size: 18px;
                animation-delay: ${delay}s;
                filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
              ">‚û§</div>
            `;
          }
          
          arrowsHtml += '</div>';
          
          const windIcon = L.divIcon({
            className: 'wind-arrow-marker',
            html: arrowsHtml,
            iconSize: [haloSize, haloSize],
            iconAnchor: [haloSize / 2, haloSize / 2]
          });
          
          const offsetLat = lat + 0.003;
          const offsetLon = lon + 0.003;
          windArrow = L.marker([offsetLat, offsetLon], { icon: windIcon }).addTo(fishingMap);
          windArrow.bindPopup(`<strong>üí® –í—ñ—Ç–µ—Ä: ${(windDirection.toFixed(0))}¬∞</strong>`);
        }
        
        fishingMap.panTo([lat, lon]);
      };
      
      // Initialize Leaflet map
      window.initLeafletMap = function(containerId, lat, lon, zoom) {
        console.log('üó∫Ô∏è Initializing Leaflet map in container:', containerId);
        
        if (fishingMap) {
          console.log('Removing existing map');
          fishingMap.remove();
        }
        
        const container = document.getElementById(containerId);
        if (!container) {
          console.error('‚ùå Container element not found:', containerId);
          return;
        }
        
        console.log('Container found, size:', container.offsetWidth, 'x', container.offsetHeight);
        
        fishingMap = L.map(containerId, {
          attributionControl: true,
          preferCanvas: true
        }).setView([lat, lon], zoom);
        
        console.log('Map instance created:', !!fishingMap);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 18,
          minZoom: 3
        }).addTo(fishingMap);
        
        console.log('‚úÖ Tile layer added');
        
        setTimeout(() => {
          if (fishingMap) {
            fishingMap.invalidateSize();
            console.log('‚úÖ Map size invalidated');
          }
        }, 100);
        
        // Add fishing spots for Ukraine
        const fishingSpots = [
          { name: '–ö–∏—ó–≤—Å—å–∫–µ –≤–æ–¥–æ—Å—Ö–æ–≤–∏—â–µ', lat: 50.6, lon: 30.5, fish: '–©—É–∫–∞, –û–∫—É–Ω—å, –°—É–¥–∞–∫' },
          { name: '–ö–∞–Ω—ñ–≤—Å—å–∫–µ –≤–æ–¥–æ—Å—Ö–æ–≤–∏—â–µ', lat: 49.4, lon: 31.5, fish: '–õ—è—â, –ö–∞—Ä–∞—Å—å, –°–æ–º' },
          { name: '–î–Ω—ñ–ø—Ä–æ (–ó–∞–ø–æ—Ä—ñ–∂–∂—è)', lat: 47.85, lon: 35.15, fish: '–°—É–¥–∞–∫, –©—É–∫–∞, –ö–æ—Ä–æ–ø' },
          { name: '–ö–∞—Ö–æ–≤—Å—å–∫–µ –≤–æ–¥–æ—Å—Ö–æ–≤–∏—â–µ', lat: 46.8, lon: 33.5, fish: '–°–æ–º, –ö–∞—Ä–∞—Å—å, –°—É–¥–∞–∫' },
          { name: '–î–µ—Å–Ω–∞', lat: 51.5, lon: 31.3, fish: '–ü–ª–æ—Ç–≤–∞, –õ—è—â, –û–∫—É–Ω—å' },
          { name: '–î–Ω—ñ—Å—Ç–µ—Ä', lat: 48.5, lon: 27.0, fish: '–ö–æ—Ä–æ–ø, –ë—ñ–ª–∏–π –∞–º—É—Ä' },
          { name: '–ü—ñ–≤–¥–µ–Ω–Ω–∏–π –ë—É–≥', lat: 48.0, lon: 30.2, fish: '–õ—è—â, –°—É–¥–∞–∫' },
          { name: '–°—ñ–≤–µ—Ä—Å—å–∫–∏–π –î–æ–Ω–µ—Ü—å', lat: 49.0, lon: 37.8, fish: '–©—É–∫–∞, –û–∫—É–Ω—å, –ß–µ—Ö–æ–Ω—å' }
        ];
        
        fishingSpots.forEach(spot => {
          const icon = L.divIcon({
            className: 'fishing-spot-marker',
            html: '<div style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üêü</div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });
          
          const marker = L.marker([spot.lat, spot.lon], { icon: icon }).addTo(fishingMap);
          marker.bindPopup(`
            <div style="min-width: 150px;">
              <strong style="color: #1e40af;">üé£ ${spot.name}</strong><br/>
              <span style="font-size: 12px; color: #64748b;">üêü ${spot.fish}</span>
            </div>
          `);
        });
        
        fishingMap.on('click', function(e) {
          const lat = e.latlng.lat;
          const lon = e.latlng.lng;
          
          if (clickCallback) {
            clickCallback(lat, lon);
          }
        });
      };
      
      // Update or create marker
      window.updateLeafletMarker = function(lat, lon) {
        if (!fishingMap) return;
        
        if (currentMarker) {
          fishingMap.removeLayer(currentMarker);
        }
        
        // Create improved fishing location marker with animation
        const fishIcon = L.divIcon({
          className: 'custom-fish-marker',
          html: `
            <div style="position: relative; width: 50px; height: 50px;">
              <!-- Outer glow ring -->
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                          width: 50px; height: 50px; border-radius: 50%;
                          background: radial-gradient(circle, rgba(34, 197, 94, 0.3) 0%, transparent 70%);
                          animation: pulse-ring 2s infinite;"></div>
              
              <!-- Main marker circle -->
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                          width: 42px; height: 42px; border-radius: 50%;
                          background: linear-gradient(135deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
                          border: 3px solid white;
                          box-shadow: 0 4px 12px rgba(0,0,0,0.3), inset 0 2px 4px rgba(255,255,255,0.3);
                          display: flex; align-items: center; justify-content: center;">
                
                <!-- Fishing icon -->
                <span style="font-size: 24px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));">üé£</span>
              </div>
              
              <!-- Small ripple effect -->
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                          width: 60px; height: 60px; border-radius: 50%;
                          border: 2px solid rgba(34, 197, 94, 0.5);
                          animation: pulse-dot 2s infinite;"></div>
            </div>
          `,
          iconSize: [50, 50],
          iconAnchor: [25, 25]
        });
        
        currentMarker = L.marker([lat, lon], { icon: fishIcon }).addTo(fishingMap);
        
        currentMarker.bindPopup(`
          <div style="text-align: center; padding: 8px;">
            <strong style="color: #16a34a; font-size: 15px;">üé£ –ú—ñ—Å—Ü–µ –ª–æ–≤—É</strong><br/>
            <span style="font-family: monospace; color: #64748b; font-size: 13px;">${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞</span>
          </div>
        `).openPopup();
        
        fishingMap.panTo([lat, lon]);
      };
      
      // Set click handler callback
      window.setLeafletClickHandler = function(callback) {
        clickCallback = callback;
      };
    </script>
  </body>
</html>
