<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="theme-color" content="#2563eb" />
    <meta name="description" content="üé£ Fishing Forecast - AI-powered fishing prediction app with weather data, catch logging, and personalized forecasts." />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Fishing Forecast" />
    
    <title>Fishing Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    
    <!-- Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('‚úÖ Service Worker registered:', registration.scope);
            })
            .catch(error => {
              console.log('‚ùå Service Worker registration failed:', error);
            });
        });
      }
    </script>
  </head>
  <body>
    <div id="main"></div>
    
    <style>
      /* Ensure Leaflet container has proper dimensions */
      #leaflet-map {
        position: relative !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 1;
      }
      
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
      }
      
      #main {
        width: 100%;
        height: 100%;
      }
    </style>
    
    <script>
      // Global variables for Leaflet map
      let fishingMap = null;
      let currentMarker = null;
      let userMarker = null;
      let windArrow = null;
      let clickCallback = null;
      let userLocation = null;
      let currentWindDirection = 0;
      
      // Offline status indicator
      window.addEventListener('online', () => {
        console.log('üü¢ Back online');
        const status = document.getElementById('connection-status');
        if (status) status.remove();
      });
      
      window.addEventListener('offline', () => {
        console.log('üî¥ Went offline');
        const status = document.createElement('div');
        status.id = 'connection-status';
        status.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-9999';
        status.innerHTML = '‚ö†Ô∏è –û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º';
        document.body.appendChild(status);
      });
      
      // Get user location
      window.getUserLocation = function(callback) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function(position) {
              userLocation = {
                lat: position.coords.latitude,
                lon: position.coords.longitude
              };
              callback(userLocation.lat, userLocation.lon);
            },
            function(error) {
              console.error('Geolocation error:', error);
              // Use default location if geolocation fails
              userLocation = { lat: 50.45, lon: 30.52 }; // Kyiv default
              callback(userLocation.lat, userLocation.lon);
            }
          );
        } else {
          console.log('Geolocation not supported');
          userLocation = { lat: 50.45, lon: 30.52 };
          callback(userLocation.lat, userLocation.lon);
        }
      };
      
      // Request geolocation on page load and update marker
      function requestGeolocationWithRetry() {
        if (navigator.geolocation) {
          console.log('üåç Requesting geolocation from browser...');
          navigator.geolocation.getCurrentPosition(
            function(position) {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              const accuracy = position.coords.accuracy;
              console.log('‚úÖ Geolocation success:', lat.toFixed(4), lon.toFixed(4), 'accuracy:', Math.round(accuracy), 'm');
              userLocation = { lat: lat, lon: lon };
              
              // Store in localStorage for offline use
              try {
                localStorage.setItem('user_location', JSON.stringify(userLocation));
                localStorage.setItem('last_location_time', Date.now().toString());
              } catch (e) {
                console.log('Could not save to localStorage:', e);
              }
              
              console.log('üìç Attempting to update marker with real geolocation...');
              window.updateUserMarker(lat, lon, 0.0, 0.0);
            },
            function(error) {
              console.warn('‚ùå Geolocation error:', error.code, error.message);
              // Try to restore from localStorage
              try {
                const stored = localStorage.getItem('user_location');
                if (stored) {
                  const loc = JSON.parse(stored);
                  console.log('Using stored location:', loc.lat, loc.lon);
                  userLocation = loc;
                  window.updateUserMarker(loc.lat, loc.lon, 0.0, 0.0);
                  return;
                }
              } catch (e) {
                console.log('Could not restore from localStorage:', e);
              }
              // Fall back to Kyiv center
              console.log('Using Kyiv as fallback');
              userLocation = { lat: 50.45, lon: 30.52 };
              window.updateUserMarker(50.45, 30.52, 0.0, 0.0);
            },
            {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 0
            }
          );
        } else {
          console.log('Geolocation not supported by this browser');
          userLocation = { lat: 50.45, lon: 30.52 };
        }
      }
      
      // Request geolocation immediately on page load
      document.addEventListener('DOMContentLoaded', requestGeolocationWithRetry);
      
      // Also try after delay to ensure browser permissions are ready
      setTimeout(requestGeolocationWithRetry, 500);
      setTimeout(requestGeolocationWithRetry, 2000);
      
      // Watch for the leaflet-map container and ensure it's initialized
      function checkAndInitializeMap() {
        const container = document.getElementById('leaflet-map');
        if (container && !fishingMap) {
          console.log('üìç Leaflet container found, container size:', container.offsetWidth, 'x', container.offsetHeight);
          if (container.offsetWidth > 0 && container.offsetHeight > 0) {
            console.log('üó∫Ô∏è Container has size, initializing map...');
            setTimeout(() => {
              if (!fishingMap) {
                console.log('‚ö†Ô∏è Map still not initialized, checking...');
              } else {
                console.log('‚úÖ Map is ready, triggering geolocation update...');
                requestGeolocationWithRetry();
              }
            }, 500);
          } else {
            console.log('‚ö†Ô∏è Container not ready yet, size:', container.offsetWidth, 'x', container.offsetHeight);
          }
        }
      }
      
      // Check for container every 100ms for first 2 seconds
      let checkCount = 0;
      const mapCheckInterval = setInterval(() => {
        checkAndInitializeMap();
        checkCount++;
        if (checkCount > 20) {
          clearInterval(mapCheckInterval);
        }
      }, 100);
      
      // Add CSS animations for wind halo
      const windStyle = document.createElement('style');
      windStyle.textContent = `
        @keyframes wind-pulse {
          0% {
            opacity: 0.3;
            transform: scale(0.8);
          }
          50% {
            opacity: 1;
            transform: scale(1.2);
          }
          100% {
            opacity: 0.3;
            transform: scale(0.8);
          }
        }
        
        @keyframes wind-float {
          0%, 100% {
            transform: translateY(0px);
          }
          50% {
            transform: translateY(-8px);
          }
        }
        
        .wind-arrow-halo {
          animation: wind-float 2s ease-in-out infinite;
        }
        
        .wind-arrow-small {
          animation: wind-pulse 2s ease-in-out infinite;
        }
      `;
      document.head.appendChild(windStyle);
      
      // Update user marker on map
      window.updateUserMarker = function(lat, lon, heading, windDirection) {
        console.log('üìå updateUserMarker called with:', lat.toFixed(4), lon.toFixed(4), 'fishingMap ready:', !!fishingMap);
        
        if (!fishingMap) {
          console.log('‚ö†Ô∏è Map not ready for updateUserMarker, but continuing...');
          const container = document.getElementById('leaflet-map');
          if (container && !container.firstChild) {
            console.log('üó∫Ô∏è Initializing map from updateUserMarker');
            window.initLeafletMap('leaflet-map', lat, lon, 10);
          } else if (!container) {
            console.error('‚ùå Container not found!');
            return;
          }
          setTimeout(() => window.updateUserMarker(lat, lon, heading, windDirection), 500);
          return;
        }
        
        console.log('‚úÖ Map is ready, adding user marker at', lat.toFixed(4), lon.toFixed(4));
        
        currentWindDirection = windDirection || 0;
        
        if (userMarker) {
          fishingMap.removeLayer(userMarker);
        }
        if (windArrow) {
          fishingMap.removeLayer(windArrow);
        }
        
        const userIcon = L.divIcon({
          className: 'user-location-marker user-location-dot',
          html: `<svg width="56" height="56" viewBox="0 0 56 56">
            <!-- Red fishing ball at top -->
            <circle cx="28" cy="10" r="8" fill="#ff5252" stroke="#ff5252" stroke-width="1.5"/>
            <!-- Shimmer highlight -->
            <ellipse cx="23" cy="7" rx="2" ry="2.5" fill="#ff8a80" opacity="0.6"/>
            <!-- Stem connecting to crosshair -->
            <rect x="26" y="18" width="4" height="18" rx="2" fill="#3d4d57"/>
            <!-- Crosshair horizontal -->
            <line x1="10" y1="38" x2="46" y2="38" stroke="#3d4d57" stroke-width="5" stroke-linecap="round"/>
            <!-- Crosshair vertical -->
            <line x1="28" y1="22" x2="28" y2="56" stroke="#3d4d57" stroke-width="5" stroke-linecap="round"/>
          </svg>`,
          iconSize: [56, 56],
          iconAnchor: [28, 38],
          popupAnchor: [0, -40]
        });
        
        userMarker = L.marker([lat, lon], { icon: userIcon }).addTo(fishingMap);
        userMarker.bindPopup(`<div style="text-align: center; padding: 5px;"><strong style="color: #2563eb;">üìç –í–∞—à–µ –º—ñ—Å—Ü–µ —Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è</strong><br/><span style="font-family: monospace; font-size: 12px;">${lat.toFixed(4)}¬∞, ${lon.toFixed(4)}¬∞</span></div>`);
        
        if (windDirection !== undefined && windDirection !== null) {
          // Create wind halo with multiple animated arrows
          const numArrows = 6; // 6 arrows in a circle
          const baseDistance = 50; // Distance from center
          
          // Create SVG with animated arrow halo
          const windIcon = L.divIcon({
            className: 'wind-arrow-halo',
            html: `<svg width="120" height="120" viewBox="0 0 120 120" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));">
              <!-- Center circle -->
              <circle cx="60" cy="60" r="8" fill="#2563eb" opacity="0.7"/>
              
              <!-- Create arrow rays pointing outward from main wind direction -->
              ${Array.from({ length: numArrows }).map((_, i) => {
                const angle = (windDirection + (i - Math.floor(numArrows / 2)) * 60) * Math.PI / 180;
                const x = 60 + Math.cos(angle) * 35;
                const y = 60 + Math.sin(angle) * 35;
                const arrowAngle = windDirection + (i - Math.floor(numArrows / 2)) * 60;
                const opacity = i === Math.floor(numArrows / 2) ? 1 : 0.6;
                const scale = i === Math.floor(numArrows / 2) ? 1 : 0.7;
                
                return `
                  <g transform="translate(${x}, ${y}) rotate(${arrowAngle})" opacity="${opacity}" style="transform-origin: center">
                    <!-- Arrow head -->
                    <polygon points="0,-15 8,-2 -8,-2" fill="#3b82f6" style="transform: scale(${scale})"/>
                    <!-- Arrow shaft -->
                    <line x1="0" y1="-15" x2="0" y2="10" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" style="transform: scale(${scale})"/>
                  </g>
                `;
              }).join('')}
              
              <!-- Outer ring that pulses -->
              <circle cx="60" cy="60" r="45" fill="none" stroke="#60a5fa" stroke-width="1" opacity="0.4" style="animation: wind-pulse 2s ease-in-out infinite;"/>
            </svg>`,
            iconSize: [120, 120],
            iconAnchor: [60, 60],
            popupAnchor: [0, -70]
          });
          
          windArrow = L.marker([lat, lon], { icon: windIcon }).addTo(fishingMap);
          windArrow.bindPopup(`<strong>üí® –í—ñ—Ç–µ—Ä: ${(windDirection.toFixed(0))}¬∞</strong>`);
        }
        
        fishingMap.panTo([lat, lon]);
      };
      
      // Initialize Leaflet map
      window.initLeafletMap = function(containerId, lat, lon, zoom) {
        console.log('üó∫Ô∏è Initializing Leaflet map in container:', containerId);
        
        if (fishingMap) {
          console.log('Removing existing map');
          fishingMap.remove();
        }
        
        const container = document.getElementById(containerId);
        if (!container) {
          console.error('‚ùå Container element not found:', containerId);
          return;
        }
        
        console.log('Container found, size:', container.offsetWidth, 'x', container.offsetHeight);
        
        fishingMap = L.map(containerId, {
          attributionControl: true,
          preferCanvas: true
        }).setView([lat, lon], zoom);
        
        console.log('Map instance created:', !!fishingMap);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 18,
          minZoom: 3
        }).addTo(fishingMap);
        
        console.log('‚úÖ Tile layer added');
        
        setTimeout(() => {
          if (fishingMap) {
            fishingMap.invalidateSize();
            console.log('‚úÖ Map size invalidated');
          }
        }, 100);
        
        // Add fishing spots for Ukraine
        const fishingSpots = [
          { name: '–ö–∏—ó–≤—Å—å–∫–µ –≤–æ–¥–æ—Å—Ö–æ–≤–∏—â–µ', lat: 50.6, lon: 30.5, fish: '–©—É–∫–∞, –û–∫—É–Ω—å, –°—É–¥–∞–∫' },
          { name: '–ö–∞–Ω—ñ–≤—Å—å–∫–µ –≤–æ–¥–æ—Å—Ö–æ–≤–∏—â–µ', lat: 49.4, lon: 31.5, fish: '–õ—è—â, –ö–∞—Ä–∞—Å—å, –°–æ–º' },
          { name: '–î–Ω—ñ–ø—Ä–æ (–ó–∞–ø–æ—Ä—ñ–∂–∂—è)', lat: 47.85, lon: 35.15, fish: '–°—É–¥–∞–∫, –©—É–∫–∞, –ö–æ—Ä–æ–ø' },
          { name: '–ö–∞—Ö–æ–≤—Å—å–∫–µ –≤–æ–¥–æ—Å—Ö–æ–≤–∏—â–µ', lat: 46.8, lon: 33.5, fish: '–°–æ–º, –ö–∞—Ä–∞—Å—å, –°—É–¥–∞–∫' },
          { name: '–î–µ—Å–Ω–∞', lat: 51.5, lon: 31.3, fish: '–ü–ª–æ—Ç–≤–∞, –õ—è—â, –û–∫—É–Ω—å' },
          { name: '–î–Ω—ñ—Å—Ç–µ—Ä', lat: 48.5, lon: 27.0, fish: '–ö–æ—Ä–æ–ø, –ë—ñ–ª–∏–π –∞–º—É—Ä' },
          { name: '–ü—ñ–≤–¥–µ–Ω–Ω–∏–π –ë—É–≥', lat: 48.0, lon: 30.2, fish: '–õ—è—â, –°—É–¥–∞–∫' },
          { name: '–°—ñ–≤–µ—Ä—Å—å–∫–∏–π –î–æ–Ω–µ—Ü—å', lat: 49.0, lon: 37.8, fish: '–©—É–∫–∞, –û–∫—É–Ω—å, –ß–µ—Ö–æ–Ω—å' }
        ];
        
        fishingSpots.forEach(spot => {
          const icon = L.divIcon({
            className: 'fishing-spot-marker',
            html: '<div style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üêü</div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
          });
          
          const marker = L.marker([spot.lat, spot.lon], { icon: icon }).addTo(fishingMap);
          marker.bindPopup(`
            <div style="min-width: 150px;">
              <strong style="color: #1e40af;">üé£ ${spot.name}</strong><br/>
              <span style="font-size: 12px; color: #64748b;">üêü ${spot.fish}</span>
            </div>
          `);
        });
        
        fishingMap.on('click', function(e) {
          const lat = e.latlng.lat;
          const lon = e.latlng.lng;
          
          if (clickCallback) {
            clickCallback(lat, lon);
          }
        });
      };
      
      // Update or create marker
      window.updateLeafletMarker = function(lat, lon) {
        if (!fishingMap) return;
        
        if (currentMarker) {
          fishingMap.removeLayer(currentMarker);
        }
        
        const fishIcon = L.divIcon({
          className: 'custom-fish-marker',
          html: '<div style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; font-size: 22px;">üé£</div>',
          iconSize: [40, 40],
          iconAnchor: [20, 20]
        });
        
        currentMarker = L.marker([lat, lon], { icon: fishIcon }).addTo(fishingMap);
        
        currentMarker.bindPopup(`
          <div style="text-align: center;">
            <strong>üé£ –ú—ñ—Å—Ü–µ –ª–æ–≤—É</strong><br/>
            <span style="font-family: monospace;">${lat.toFixed(2)}¬∞, ${lon.toFixed(2)}¬∞</span>
          </div>
        `).openPopup();
        
        fishingMap.panTo([lat, lon]);
      };
      
      // Set click handler callback
      window.setLeafletClickHandler = function(callback) {
        clickCallback = callback;
      };
    </script>
  </body>
</html>
